<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        .action-buttons button { margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Панель администратора</h1>
    
    <h2>Заявки на курсы</h2>
    <table id="applicationsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ученик</th>
                <th>Класс</th>
                <th>Телефон</th>
                <th>Email</th>
                <th>Курс</th>
                <th>Дата</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <h2>Управление курсами</h2>
    <button id="addCourseBtn">Добавить курс</button>
    <table id="coursesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Описание</th>
                <th>Цена</th>
                <th>Формат</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        async function loadApplications() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const response = await fetch('/api/applications/all', {
                    headers: {
                        'x-access-token': token
                    }
                });
                
                if (response.ok) {
                    const applications = await response.json();
                    const tbody = document.querySelector('#applicationsTable tbody');
                    tbody.innerHTML = '';
                    
                    applications.forEach(app => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${app.id}</td>
                            <td>${app.studentName}</td>
                            <td>${app.grade}</td>
                            <td>${app.phone}</td>
                            <td>${app.email}</td>
                            <td>${app.Course ? app.Course.title : 'Не указан'}</td>
                            <td>${new Date(app.createdAt).toLocaleString()}</td>
                            <td>${app.status}</td>
                            <td class="action-buttons">
                                <button onclick="updateApplicationStatus(${app.id}, 'approved')">Принять</button>
                                <button onclick="updateApplicationStatus(${app.id}, 'rejected')">Отклонить</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    window.location.href = 'index.html';
                }
            } catch (err) {
                console.error(err);
            }
        }
        
        async function loadCourses() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const response = await fetch('/api/courses', {
                    headers: {
                        'x-access-token': token
                    }
                });
                
                if (response.ok) {
                    const courses = await response.json();
                    const tbody = document.querySelector('#coursesTable tbody');
                    tbody.innerHTML = '';
                    
                    courses.forEach(course => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${course.id}</td>
                            <td>${course.title}</td>
                            <td>${course.description || ''}</td>
                            <td>${course.price || ''}</td>
                            <td>${course.format || ''}</td>
                            <td class="action-buttons">
                                <button onclick="editCourse(${course.id})">Редактировать</button>
                                <button onclick="deleteCourse(${course.id})">Удалить</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (err) {
                console.error(err);
            }
        }
        
        async function updateApplicationStatus(id, status) {
            try {
                const response = await fetch(`/api/applications/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': localStorage.getItem('token')
                    },
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    alert('Статус обновлен');
                    loadApplications();
                }
            } catch (err) {
                console.error(err);
            }
        }
        
        async function deleteCourse(id) {
            if (!confirm('Вы уверены, что хотите удалить этот курс?')) return;
            
            try {
                const response = await fetch(`/api/courses/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'x-access-token': localStorage.getItem('token')
                    }
                });
                
                if (response.ok) {
                    alert('Курс удален');
                    loadCourses();
                }
            } catch (err) {
                console.error(err);
            }
        }
        
        document.getElementById('addCourseBtn').addEventListener('click', () => {
            // Реализация добавления курса
            const title = prompt('Введите название курса:');
            if (title) {
                const description = prompt('Введите описание курса:');
                const price = prompt('Введите цену курса:');
                const format = prompt('Введите формат курса:');
                
                fetch('/api/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': localStorage.getItem('token')
                    },
                    body: JSON.stringify({ title, description, price, format })
                })
                .then(response => response.json())
                .then(() => {
                    alert('Курс добавлен');
                    loadCourses();
                })
                .catch(err => console.error(err));
            }
        });
        
        function editCourse(id) {
            // Реализация редактирования курса
            const newTitle = prompt('Введите новое название курса:');
            if (newTitle) {
                const newDescription = prompt('Введите новое описание курса:');
                const newPrice = prompt('Введите новую цену курса:');
                const newFormat = prompt('Введите новый формат курса:');
                
                fetch(`/api/courses/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': localStorage.getItem('token')
                    },
                    body: JSON.stringify({ 
                        title: newTitle, 
                        description: newDescription,
                        price: newPrice,
                        format: newFormat
                    })
                })
                .then(response => response.json())
                .then(() => {
                    alert('Курс обновлен');
                    loadCourses();
                })
                .catch(err => console.error(err));
            }
        }
        
        // Проверка авторизации при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            // Здесь можно добавить проверку роли пользователя
            loadApplications();
            loadCourses();
        });
    </script>
</body>
</html>
